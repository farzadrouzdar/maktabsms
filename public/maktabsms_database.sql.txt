-- تنظیمات دیتابیس
SET SQL_MODE = "NO_AUTO_VALUE_ON_ZERO";
SET AUTOCOMMIT = 0;
START TRANSACTION;
SET time_zone = "+00:00";

-- حذف دیتابیس اگه وجود داره (اختیاری، فقط برای اطمینان از ساختار جدید)
-- DROP DATABASE IF EXISTS maktabsms;
-- CREATE DATABASE maktabsms;
-- USE maktabsms;

-- جدول schools
CREATE TABLE IF NOT EXISTS schools (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    education_type VARCHAR(50) NOT NULL,
    school_type VARCHAR(50) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- جدول users
CREATE TABLE IF NOT EXISTS users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    school_id INT NOT NULL,
    mobile VARCHAR(15) NOT NULL,
    role ENUM('admin', 'user') DEFAULT 'user',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (school_id) REFERENCES schools(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- جدول contact_groups
CREATE TABLE IF NOT EXISTS contact_groups (
    id INT AUTO_INCREMENT PRIMARY KEY,
    school_id INT NOT NULL,
    name VARCHAR(100) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (school_id) REFERENCES schools(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- جدول contacts
CREATE TABLE IF NOT EXISTS contacts (
    id INT AUTO_INCREMENT PRIMARY KEY,
    school_id INT NOT NULL,
    group_id INT NULL,
    first_name VARCHAR(100) NULL,
    last_name VARCHAR(100) NULL,
    mobile VARCHAR(15) NOT NULL,
    birth_date DATE NULL,
    field1 VARCHAR(255) NULL,
    field2 VARCHAR(255) NULL,
    field3 VARCHAR(255) NULL,
    field4 VARCHAR(255) NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (school_id) REFERENCES schools(id),
    FOREIGN KEY (group_id) REFERENCES contact_groups(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- جدول drafts
CREATE TABLE IF NOT EXISTS drafts (
    id INT AUTO_INCREMENT PRIMARY KEY,
    school_id INT NOT NULL,
    title VARCHAR(100) NOT NULL,
    message TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (school_id) REFERENCES schools(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- جدول sms_logs
CREATE TABLE IF NOT EXISTS sms_logs (
    id INT AUTO_INCREMENT PRIMARY KEY,
    school_id INT NOT NULL,
    recipient VARCHAR(15) NOT NULL,
    message TEXT NOT NULL,
    batch_id VARCHAR(50) NULL,
    reference_id VARCHAR(50) NULL,
    status VARCHAR(50) DEFAULT 'pending',
    sent_at DATETIME NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (school_id) REFERENCES schools(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- آپدیت جدول contacts برای اطمینان از وجود ستون‌ها
ALTER TABLE contacts
    ADD COLUMN first_name VARCHAR(100) NULL AFTER group_id,
    ADD COLUMN last_name VARCHAR(100) NULL AFTER first_name,
    ADD COLUMN birth_date DATE NULL AFTER mobile,
    ADD COLUMN field1 VARCHAR(255) NULL AFTER birth_date,
    ADD COLUMN field2 VARCHAR(255) NULL AFTER field1,
    ADD COLUMN field3 VARCHAR(255) NULL AFTER field2,
    ADD COLUMN field4 VARCHAR(255) NULL AFTER field3;

-- حذف ستون‌های قدیمی اگه وجود دارن
ALTER TABLE contacts DROP COLUMN IF EXISTS name;
ALTER TABLE contacts DROP COLUMN IF EXISTS notes;

-- آپدیت جدول users برای اطمینان از وجود school_id
ALTER TABLE users
    ADD COLUMN school_id INT NOT NULL DEFAULT 1 AFTER id,
    ADD FOREIGN KEY (school_id) REFERENCES schools(id);

-- افزودن داده‌های نمونه
INSERT IGNORE INTO schools (name, education_type, school_type) VALUES
    ('مدرسه نمونه', 'دبستان', 'دولتی');

INSERT IGNORE INTO users (school_id, mobile, role) VALUES
    (1, '09120000000', 'admin');

INSERT IGNORE INTO contact_groups (school_id, name) VALUES
    (1, 'گروه تست'),
    (1, 'والدین دانش‌آموزان');

INSERT IGNORE INTO contacts (school_id, group_id, first_name, last_name, mobile, birth_date, field1) VALUES
    (1, 1, 'علی', 'محمدی', '09120000000', '1990-05-15', 'دانش‌آموز'),
    (1, 2, 'سارا', 'احمدی', '09130000000', '1985-08-20', 'والدین');

INSERT IGNORE INTO drafts (school_id, title, message) VALUES
    (1, 'پیش‌نویس تست', 'این یک پیامک تستی است.');

INSERT IGNORE INTO sms_logs (school_id, recipient, message, status) VALUES
    (1, '09120000000', 'پیامک تست', 'sent');

COMMIT;